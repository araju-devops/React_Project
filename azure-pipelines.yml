trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '18.x'

stages:
  - stage: Build
    displayName: 'Build React App'
    jobs:
      - job: Build
        displayName: 'Build'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '$(nodeVersion)'
            displayName: 'Install Node.js'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run build
            displayName: 'Build application'

          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/build'
              artifact: 'react-app'
              publishLocation: 'pipeline'
            displayName: 'Publish build artifact'

  - stage: Deploy
    displayName: 'Deploy to Azure Static Web App'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: 'Deploy'
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifact: 'react-app'
              path: '$(Pipeline.Workspace)/react-app'

          - task: AzureStaticWebApp@0
            inputs:
              azure_static_web_apps_api_token: $(deployment_token)
              app_location: '$(Pipeline.Workspace)/react-app'
              skip_app_build: true
              skip_api_build: true
